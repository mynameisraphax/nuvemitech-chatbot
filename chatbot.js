const { default: makeWASocket, DisconnectReason, useMultiFileAuthState } = require('@whiskeysockets/baileys');
const qrcode = require('qrcode-terminal');
const sqlite3 = require('sqlite3').verbose();
const bcrypt = require('bcrypt');
const { DateTime } = require('luxon');
const dotenv = require('dotenv');
const fs = require('fs');
const P = require('pino');

dotenv.config();

const dbPath = process.env.NODE_ENV === 'production' ? '/opt/render/project/src/data/leads.db' : './leads.db';
const db = new sqlite3.Database(dbPath, (err) => {
  if (err) console.error('Erro ao conectar ao SQLite:', err.message);
  else console.log('Conectado ao SQLite.');
});

db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS leads (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      phone TEXT NOT NULL,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);
  db.run(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT NOT NULL UNIQUE,
      password TEXT NOT NULL
    )
  `);
  const defaultUser = 'admin';
  const defaultPassword = 'admin123';
  bcrypt.hash(defaultPassword, 10, (err, hash) => {
    if (err) console.error('Erro ao criar usu√°rio padr√£o:', err.message);
    db.run(
      'INSERT OR IGNORE INTO users (username, password) VALUES (?, ?)',
      [defaultUser, hash],
      (err) => {
        if (err) console.error('Erro ao inserir usu√°rio padr√£o:', err.message);
      }
    );
  });
});

async function connectToWhatsApp() {
  const authPath = process.env.NODE_ENV === 'production' ? '/opt/render/project/src/data/.wwebjs_auth' : './.wwebjs_auth';
  const { state, saveCreds } = await useMultiFileAuthState(authPath);
  const sock = makeWASocket({
    auth: state,
    logger: P({ level: 'error' }),
    printQRInTerminal: false
  });

  sock.ev.on('connection.update', async (update) => {
    const { connection, lastDisconnect, qr } = update;
    if (qr) {
      console.log('QR code gerado.');
      qrcode.generate(qr, { small: true });
      console.log('Escaneie o QR code com o WhatsApp Business.');
    }
    if (connection === 'close') {
      const shouldReconnect = lastDisconnect?.error?.output?.statusCode !== DisconnectReason.loggedOut;
      console.error('Desconectado:', lastDisconnect?.error?.message);
      if (shouldReconnect) {
        setTimeout(() => connectToWhatsApp(), 15000);
      } else {
        console.error('Sess√£o encerrada. Remova a pasta .wwebjs_auth e reinicie.');
        process.exit(1);
      }
    } else if (connection === 'open') {
      console.log('Chatbot da NuvemITech online!');
    }
  });

  sock.ev.on('creds.update', saveCreds);

  const conversationState = {};
  const pausedConversations = {};
  const ADMIN_NUMBER = '5511962823519@s.whatsapp.net';

  const services = {
    computadores: [
      'Formata√ß√£o e reinstala√ß√£o de sistemas',
      'Limpeza interna e externa',
      'Upgrade de hardware (SSD, RAM, processadores)',
      'Atualiza√ß√£o de BIOS',
      'Manuten√ß√£o preventiva e corretiva',
      'Diagn√≥sticos avan√ßados',
      'Recupera√ß√£o de dados',
      'Configura√ß√£o de backups e solu√ß√µes em nuvem',
      'Instala√ß√£o e configura√ß√£o de servidores',
      'Suporte remoto para problemas comuns',
      'Instala√ß√£o de antiv√≠rus e seguran√ßa digital',
      'Otimiza√ß√£o de desempenho para gamers e designers',
    ],
    redes: [
      'Projeto e estrutura√ß√£o de redes',
      'Instala√ß√£o e configura√ß√£o de roteadores',
      'Manuten√ß√£o preventiva de redes',
      'Instala√ß√£o de cabos e conex√µes de internet',
      'Configura√ß√£o de servidores de rede e firewall',
      'Consultoria para melhoria de conex√µes empresariais',
      'Instala√ß√£o de VPNs para acesso remoto seguro',
      'Configura√ß√£o de sistemas de monitoramento remoto',
    ],
    desenvolvimento: [
      'Automatiza√ß√µes de agentes IA Chatbots',
      'Sites Completos ou Landing Pages',
      'Automatizadores de An√°lise de Dados (Python)',
      'Banco de dados',
      'APIs de consulta',
      'Ferramentas de melhorias para o dia a dia',
    ],
  };

  function getGreeting() {
    const hour = DateTime.now().setZone('America/Sao_Paulo').hour;
    if (hour < 12) return 'Bom dia';
    if (hour < 18) return 'Boa tarde';
    return 'Boa noite';
  }

  function saveLead(name, phone, callback) {
    db.run(
      'INSERT INTO leads (name, phone) VALUES (?, ?)',
      [name, phone],
      (err) => {
        if (err) console.error('Erro ao salvar lead:', err.message);
        callback(err);
      }
    );
  }

  async function sendPromotion(promoText, imagePath = './public/promo.jpg') {
    db.all('SELECT phone FROM leads', [], async (err, leads) => {
      if (err) {
        console.error('Erro ao buscar leads para promo√ß√£o:', err.message);
        return;
      }
      for (const lead of leads) {
        if (pausedConversations[lead.phone]) continue;
        try {
          console.log(`Enviando promo√ß√£o para ${lead.phone}`);
          const media = {
            mimetype: 'image/jpeg',
            data: fs.readFileSync(imagePath).toString('base64')
          };
          await sock.sendMessage(`${lead.phone.replace('+', '')}@s.whatsapp.net`, {
            image: media,
            caption: promoText
          });
          console.log(`Promo√ß√£o enviada para ${lead.phone}`);
        } catch (error) {
          console.error(`Erro ao enviar promo√ß√£o para ${lead.phone}:`, error.message);
        }
      }
    });
  }

  function handleGeneralQuestions(text, name) {
    const lowerText = text.toLowerCase();
    const greeting = getGreeting();
    if (lowerText.includes('que dia') || lowerText.includes('hoje √©')) {
      const today = DateTime.now().setZone('America/Sao_Paulo').toFormat('cccc, dd/MM/yyyy');
      return `${greeting}, ${name}! Hoje √© ${today}. üòä Alguma coisa especial planejada ou quer falar sobre como a NuvemITech pode te ajudar?`;
    } else if (lowerText.includes('clima') || lowerText.includes('tempo')) {
      return `${greeting}, ${name}! O clima em S√£o Paulo t√° naquele estilo imprevis√≠vel, n√©? üå¶Ô∏è Mas n√£o se preocupe, a NuvemITech deixa sua tecnologia sempre no sol! üòé Quer saber mais sobre nossos servi√ßos?`;
    } else if (lowerText.includes('pre√ßo') || lowerText.includes('quanto custa')) {
      return `${greeting}, ${name}! Os pre√ßos variam conforme o servi√ßo, mas garanto que s√£o justos e com qualidade top! üòä Quer que eu te passe mais detalhes ou prefere agendar uma conversa com nossa equipe digitando *AGENDAR*?`;
    } else if (lowerText.includes('onde') || lowerText.includes('localiza√ß√£o')) {
      return `${greeting}, ${name}! Estamos em S√£o Paulo! Atendemos presencialmente e remotamente, conforme sua necessidade. üòÑ Digite *AGENDAR* para combinar um atendimento ou me conta o que precisa!`;
    }
    return null;
  }

  function generateWelcomeMessage(name) {
    const greeting = getGreeting();
    return `${greeting}, ${name}! üå©Ô∏è *Bem-vindo(a) √† NuvemITech!* üå©Ô∏è\n\nSomos especialistas em *TI, redes e desenvolvimento* em S√£o Paulo, com anos de experi√™ncia transformando tecnologia em resultados! üöÄ\n\n*Por que nos escolher?*\n‚úÖ *Expertise*: J√° ajudamos centenas de clientes a resolverem problemas complexos.\n‚úÖ *Oferta Exclusiva*: Agende hoje e ganhe uma *an√°lise inicial gr√°tis* (s√≥ para os primeiros 10 do m√™s)!\n‚úÖ *Prova Social*: "A NuvemITech otimizou nossa rede e dobrou nossa produtividade!" - Cliente satisfeito.\n\n*Como posso te ajudar hoje?*\n1Ô∏è‚É£ Computadores\n2Ô∏è‚É£ Redes\n3Ô∏è‚É£ Desenvolvimento\n\nDigite o n√∫mero da op√ß√£o ou me conte o que precisa! üòä`;
  }

  async function checkExistingLead(phone, callback) {
    db.get('SELECT name FROM leads WHERE phone = ?', [phone], (err, row) => {
      if (err) {
        console.error('Erro ao consultar lead:', err.message);
        callback(err, null);
      } else {
        callback(null, row ? row.name : null);
      }
    });
  }

  sock.ev.on('messages.upsert', async ({ messages }) => {
    const message = messages[0];
    if (!message.message) return;
    const userId = message.key.remoteJid;
    const text = message.message.conversation || message.message.extendedTextMessage?.text || '';
    const lowerText = text.toLowerCase();
    console.log(`Mensagem recebida de ${userId}: ${text}`);

    if (userId === ADMIN_NUMBER && lowerText.startsWith('pausar ')) {
      const phone = text.split(' ')[1];
      if (phone) {
        pausedConversations[phone] = DateTime.now().plus({ hours: 24 }).toISO();
        await sock.sendMessage(userId, { text: `Conversa com ${phone} pausada por 24 horas.` });
      }
      return;
    }

    if (userId === ADMIN_NUMBER && lowerText.startsWith('retomar ')) {
      const phone = text.split(' ')[1];
      if (phone && pausedConversations[phone]) {
        delete pausedConversations[phone];
        await sock.sendMessage(userId, { text: `Conversa com ${phone} retomada.` });
      }
      return;
    }

    if (pausedConversations[userId.replace('@s.whatsapp.net', '')] && DateTime.now().toISO() < pausedConversations[userId.replace('@s.whatsapp.net', '')]) {
      return;
    }

    if (lowerText === 'enviar promo' && userId === ADMIN_NUMBER) {
      await sendPromotion('üåü *Oferta Exclusiva NuvemITech!* 20% de desconto na formata√ß√£o de PCs ou configura√ß√£o de redes! Agende agora pelo +5511962823519 e aproveite! üöÄ');
      await sock.sendMessage(userId, { text: 'Promo√ß√£o enviada para todos os leads! üöÄ' });
      return;
    }

    if (!conversationState[userId]) {
      checkExistingLead(userId.replace('@s.whatsapp.net', ''), async (err, name) => {
        if (err) {
          await sock.sendMessage(userId, { text: `${getGreeting()}! üòä Algo deu errado, mas vamos come√ßar! Me diz seu nome, por favor!` });
          conversationState[userId] = { step: 'ask_name' };
          return;
        }
        if (name) {
          conversationState[userId] = { step: 'initial', name, phone: userId.replace('@s.whatsapp.net', '') };
          await sock.sendMessage(userId, { text: generateWelcomeMessage(name) });
          await sock.sendMessage(
            ADMIN_NUMBER,
            { text: `Lead retornou! Nome: ${name}, Telefone: ${userId.replace('@s.whatsapp.net', '')}` }
          );
        } else {
          conversationState[userId] = { step: 'ask_name' };
          await sock.sendMessage(userId, { text: `${getGreeting()}! üòä Antes de come√ßarmos, me diz seu nome, por favor!` });
        }
      });
      return;
    }

    const state = conversationState[userId];

    if (state.step === 'ask_name') {
      state.name = text;
      state.step = 'ask_phone';
      await sock.sendMessage(userId, { text: `Beleza, ${state.name}! üòÑ Qual √© o seu n√∫mero de telefone (ex.: +5511999999999)?` });
    } else if (state.step === 'ask_phone') {
      state.phone = text;
      saveLead(state.name, state.phone, async (err) => {
        if (err) {
          await sock.sendMessage(userId, { text: `${getGreeting()}, ${state.name}! Ops, algo deu errado ao salvar seus dados. üòÖ Mas n√£o se preocupe, vamos continuar!` });
        } else {
          await sock.sendMessage(userId, { text: `${getGreeting()}, ${state.name}! Dados salvos com sucesso! üéâ` });
          await sock.sendMessage(
            ADMIN_NUMBER,
            { text: `Novo lead capturado! Nome: ${state.name}, Telefone: ${state.phone}` }
          );
        }
        state.step = 'initial';
        await sock.sendMessage(userId, { text: generateWelcomeMessage(state.name) });
      });
    } else if (state.step === 'initial') {
      const generalResponse = handleGeneralQuestions(text, state.name);
      if (generalResponse) {
        await sock.sendMessage(userId, { text: generalResponse });
        return;
      }

      if (lowerText === '1') {
        state.step = 'computadores';
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! üíª *Servi√ßos de Computadores* üíª\n\nTemos tudo pra deixar seu computador voando! Desde formata√ß√µes at√© otimiza√ß√µes para gamers e designers. Confira:\n\n${services.computadores.join(
            '\n‚Ä¢ '
          )}\n\n*Interessado?* Me conta qual servi√ßo voc√™ precisa ou digite *AGENDAR* para falar com nossa equipe! üòä\n\n*‚ö†Ô∏è Dica*: Nossos especialistas garantem um servi√ßo r√°pido e seguro, sem dor de cabe√ßa!`
        });
      } else if (lowerText === '2') {
        state.step = 'redes';
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! üåê *Solu√ß√µes em Redes* üåê\n\nProjetamos redes dom√©sticas e empresariais com m√°xima performance e seguran√ßa! Veja o que oferecemos:\n\n${services.redes.join(
            '\n‚Ä¢ '
          )}\n\n*Quer melhorar sua conex√£o?* Me diga como posso ajudar ou digite *AGENDAR* para um atendimento personalizado! üòä\n\n*‚ö†Ô∏è Dica*: Configura√ß√µes complexas? Deixe com a gente!`
        });
      } else if (lowerText === '3') {
        state.step = 'desenvolvimento';
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! üíª *Desenvolvimento Personalizado* üíª\n\nCriamos solu√ß√µes sob medida, como chatbots e sites incr√≠veis! Confira:\n\n${services.desenvolvimento.join(
            '\n‚Ä¢ '
          )}\n\n*Quer transformar sua ideia em realidade?* Me conte mais ou digite *AGENDAR* para falar com nossos desenvolvedores! üòä\n\n*‚ö†Ô∏è Dica*: Projetos personalizados exigem experi√™ncia, e n√≥s somos especialistas!`
        });
      } else if (lowerText === 'agendar') {
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! üöÄ Perfeito! Vamos agendar seu atendimento com a NuvemITech! üìû Entre em contato pelo *+55 11 96282-3519* ou me diga um hor√°rio que te ligamos! üòä\n\n*Oferta Exclusiva*: Agendando hoje, voc√™ ganha uma *an√°lise inicial gratuita*!`
        });
        state.step = 'initial';
      } else {
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! Ops, n√£o entendi! üòÖ Digite *1* para Computadores, *2* para Redes, *3* para Desenvolvimento, ou me conte o que precisa!`
        });
      }
    } else if (lowerText === 'agendar') {
      await sock.sendMessage(userId, {
        text: `${getGreeting()}, ${state.name}! üöÄ Beleza! Vamos agendar seu atendimento! üìû Ligue para *+55 11 96282-3519* ou me diga um hor√°rio que entramos em contato! üòä\n\n*Oferta Exclusiva*: Agende agora e ganhe uma *an√°lise inicial gr√°tis*!`
      });
      state.step = 'initial';
    } else {
      const generalResponse = handleGeneralQuestions(text, state.name);
      if (generalResponse) {
        await sock.sendMessage(userId, { text: generalResponse });
      } else {
        await sock.sendMessage(userId, {
          text: `${getGreeting()}, ${state.name}! üòä Me conta mais sobre o que voc√™ precisa ou digite *AGENDAR* para falar com nossa equipe!`
        });
      }
    }
  });

  return sock;
}

connectToWhatsApp().catch(console.error);